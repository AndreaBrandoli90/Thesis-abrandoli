\chapter{Bitcoin from the command line}
\label{app:A}
This appendix is aimed at providing a technical walkthrough the Bitcoin network from the command line point of view, supposing a Unix-like operating system. Initially, we will configure a machine to launch a Bitcoin node; then we will introduce some of the most important RPC (taken from... metti la fonte) in order to perform basic operations. Lastly the OpenTimestamps protocol comes into play: we will practically see how to timestamp a document using the Python client and how to set up a calendar server.
\bigskip

\section{Running a Bitcoin Core node}
To get started with Bitcoin, you first need to join the network running a node. Following these simple steps will make the first experience a lot easier.
\begin{itemize}
\item Setup variables (for an easy installation):
\bigskip
\begin{lstlisting}
 $ export BITCOIN=bitcoin-core-0.17.0
\end{lstlisting}
\item Download relevant files (Remark: every time you find username replace it with your personal one):
\bigskip
\begin{lstlisting}
 $ wget https://bitcoin.org/bin/$BITCOIN/$BITCOINPLAIN-x86_64-linux-gnu.tar.gz -O ~username/$BITCOINPLAIN-x86_64-linux-gnu.tar.gz
 $ wget https://bitcoin.org/bin/$BITCOIN/SHA256SUMS.asc -O ~username/SHA256SUMS.asc
 $ wget https://bitcoin.org/laanwj-releases.asc -O ~username/laanwj-releases.asc
\end{lstlisting}
\item Verify Bitcoin signature (in order to verify that your Bitcoin setup is authentic):
\bigskip
\begin{lstlisting}
 $ /usr/bin/gpg --import ~username/laanwj-releases.asc
 $ /usr/bin/gpg --verify ~username/SHA256SUMS.asc
\end{lstlisting}
Amongst the info you get back from the last command should be a line telling \enquote{Good signature}, do not care the rest.
\item Verify Bitcoin SHA (Secure Hash Algorithm) of the .tar file against the expected one:
\bigskip
\begin{lstlisting}
 $ /usr/bin/sha256sum ~username/$BITCOINPLAIN-x86_64-linux-gnu.tar.gz | awk '{print $1}'
 $ cat ~username/SHA256SUMS.asc | grep $BITCOINPLAIN-x86_64-linux-gnu.tar.gz | awk '{print $1}'
\end{lstlisting}
From this verification you must obtain the same number.
\item Install Bitcoin:
\bigskip
\begin{lstlisting}
 $ /bin/tar xzf ~username/$BITCOINPLAIN-x86_64-linux-gnu.tar.gz -C ~username
 $ sudo /usr/bin/install -m 0755 -o root -g root -t /usr/local/bin ~username/$BITCOINPLAIN/bin/*
 $ /bin/rm -rf ~username/$BITCOINPLAIN/
\end{lstlisting}
\item Create the configuration file:

\bigskip
\noindent
First, create the directory you want to put your data into: \bigskip
\begin{lstlisting}
 $ /bin/mkdir ~username/.bitcoin
\end{lstlisting}
Then create the configuration file (as you need it):
\bigskip
\begin{lstlisting}
 $ cat >> ~username/.bitcoin/bitcoin.conf << EOF
 # Accept command line and JSON-RPC commands
 server=1
 # Username for JSON-RPC connections
 rpcuser=invent_a_username_here
 # Password for JSON-RPC connections
 rpcpassword=invent_a_long_pwd_here
 # Enable Testnet chain mode
 testnet=1
 EOF
\end{lstlisting}
The \textit{bitcoin.conf} file is the default file which Bitcoin daemon reads when launched, and it contains instructions to configure the node (e.g. mainnet, testnet or regtest mode). In this example we define a \textit{rpcuser} and \textit{rpcpassword} to enable RPC, and we tell the node to synchronize with the Bitcoin Testnet chain. (metti una nota qui per il sito dei conf file).

\bigskip
\noindent
Finally, limit the permissions to your configuration file (not really needed, but more secure): \bigskip
\begin{lstlisting}
 $ /bin/chmod 600 ~username/.bitcoin/bitcoin.conf
\end{lstlisting}
\item Start the daemon\footnote{In multitasking computer operating systems, a \textit{daemon} is a computer program that runs as a background process, rather than being under direct control of an interactive user. Traditionally, the process names of a daemon end with the letter \textit{d}; \colorbox{Grey!10}{bitcoind} is the one which implements the Bitcoin protocol for remote procedure call (RPC) use.}:
\bigskip
\begin{lstlisting}
 $ bitcoind -daemon
\end{lstlisting}
\end{itemize}
We are now ready to be part of the Bitcoin network ! \\ 
In the next section we will learn how to manage the Bitcoin command line interface.

\bigskip

\section{Bitcoin-cli: command line interface}
In this section we will answer the following question: \enquote{\textit{What is RPC and which calls are the most used in Bitcoin?}}.

\bigskip
\noindent
Without further going into details regarding computer science\footnote{For more details, see https://en.wikipedia.org/wiki/Remote\_procedure\_call}, a RPC (Remote Procedure Call) is a powerful technique for constructing distributed, client-server based applications. It is based on the extension of the conventional procedure calling, so that the called procedure need not exist in the same address space as the calling procedure. The two processes may be on the same system, or they may be on different systems with a network connecting them. Our interest is for the \colorbox{Grey!10}{bitcoin-cli}, a handy interface that lets the user send commands to the \colorbox{Grey!10}{bitcoind}. More specifically, it lets you send RPC commands to the \colorbox{Grey!10}{bitcoind}. Generally, the \colorbox{Grey!10}{bitcoin-cli} interface is much more clean and user friendly than trying to send RPC commands by hand, using \colorbox{Grey!10}{curl} or some other method.

\bigskip
\noindent
The first thing to do for a beginner user is to look for the full list of calls invoking the \colorbox{Grey!10}{help} command:
\bigskip
\begin{lstlisting}
 $ bitcoin-cli help
 
 == Blockchain ==
 getbestblockhash
 getblock "blockhash" ( verbosity ) 
 getblockchaininfo
 getblockcount
 getblockhash height
 getblockheader "hash" ( verbose )
 getblockstats hash_or_height ( stats )
 getchaintips
 getchaintxstats ( nblocks blockhash )
 getdifficulty
 getmempoolancestors txid (verbose)
 getmempooldescendants txid (verbose)
 getmempoolentry txid
 getmempoolinfo
 getrawmempool ( verbose )
 gettxout "txid" n ( include_mempool )
 gettxoutproof ["txid",...] ( blockhash )
 gettxoutsetinfo
 preciousblock "blockhash"
 pruneblockchain
 savemempool
 scantxoutset <action> ( <scanobjects> )
 verifychain ( checklevel nblocks )
 verifytxoutproof "proof"

 == Control ==
 getmemoryinfo ("mode")
 help ( "command" )
 logging ( <include> <exclude> )
 stop
 uptime

 == Generating ==
 generate nblocks ( maxtries )
 generatetoaddress nblocks address (maxtries)

 == Mining ==
 getblocktemplate ( TemplateRequest )
 getmininginfo
 getnetworkhashps ( nblocks height )
 prioritisetransaction <txid> <dummy value> <fee delta>
 submitblock "hexdata"  ( "dummy" )

 == Network ==
 addnode "node" "add|remove|onetry"
 clearbanned
 disconnectnode "[address]" [nodeid]
 getaddednodeinfo ( "node" )
 getconnectioncount
 getnettotals
 getnetworkinfo
 getpeerinfo
 listbanned
 ping
 setban "subnet" "add|remove" (bantime) (absolute)
 setnetworkactive true|false

 == Rawtransactions ==
 combinepsbt ["psbt",...]
 combinerawtransaction ["hexstring",...]
 converttopsbt "hexstring" ( permitsigdata iswitness )
 createpsbt [{"txid":"id","vout":n},...] [{"address":amount},{"data":"hex"},...] ( locktime ) ( replaceable )
 createrawtransaction [{"txid":"id","vout":n},...] [{"address":amount},{"data":"hex"},...] ( locktime ) ( replaceable )
 decodepsbt "psbt"
 decoderawtransaction "hexstring" ( iswitness )
 decodescript "hexstring"
 finalizepsbt "psbt" ( extract )
 fundrawtransaction "hexstring" ( options iswitness )
 getrawtransaction "txid" ( verbose "blockhash" )
 sendrawtransaction "hexstring" ( allowhighfees )
 signrawtransaction "hexstring" ( [{"txid":"id","vout":n,"scriptPubKey":"hex","redeemScript":"hex"},...] ["privatekey1",...] sighashtype )
 signrawtransactionwithkey "hexstring" ["privatekey1",...] ( [{"txid":"id","vout":n,"scriptPubKey":"hex","redeemScript":"hex"},...] sighashtype )
 testmempoolaccept ["rawtxs"] ( allowhighfees )

 == Util ==
 createmultisig nrequired ["key",...] ( "address_type" )
 estimatesmartfee conf_target ("estimate_mode")
 signmessagewithprivkey "privkey" "message"
 validateaddress "address"
 verifymessage "address" "signature" "message"

 == Wallet ==
 abandontransaction "txid"
 abortrescan
 addmultisigaddress nrequired ["key",...] ( "label" "address_type" )
 backupwallet "destination"
 bumpfee "txid" ( options ) 
 createwallet "wallet_name" ( disable_private_keys )
 dumpprivkey "address"
 dumpwallet "filename"
 encryptwallet "passphrase"
 getaccount (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 getaccountaddress (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 getaddressbyaccount (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 getaddressesbylabel "label"
 getaddressinfo "address"
 getbalance ( "(dummy)" minconf include_watchonly )
 getnewaddress ( "label" "address_type" )
 getrawchangeaddress ( "address_type" )
 getreceivedbyaccount (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 getreceivedbyaddress "address" ( minconf )
 gettransaction "txid" ( include_watchonly )
 getunconfirmedbalance
 getwalletinfo
 importaddress "address" ( "label" rescan p2sh )
 importmulti "requests" ( "options" )
 importprivkey "privkey" ( "label" ) ( rescan )
 importprunedfunds
 importpubkey "pubkey" ( "label" rescan )
 importwallet "filename"
 keypoolrefill ( newsize )
 listaccounts (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 listaddressgroupings
 listlabels ( "purpose" )
 listlockunspent
 listreceivedbyaccount (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 listreceivedbyaddress ( minconf include_empty include_watchonly address_filter )
 listsinceblock ( "blockhash" target_confirmations include_watchonly include_removed )
 listtransactions (dummy count skip include_watchonly)
 listunspent ( minconf maxconf  ["addresses",...] [include_unsafe] [query_options])
 listwallets
 loadwallet "filename"
 lockunspent unlock ([{"txid":"txid","vout":n},...])
 move (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 removeprunedfunds "txid"
 rescanblockchain ("start_height") ("stop_height")
 sendfrom (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 sendmany "" {"address":amount,...} ( minconf "comment" ["address",...] replaceable conf_target "estimate_mode")
 sendtoaddress "address" amount ( "comment" "comment_to" subtractfeefromamount replaceable conf_target "estimate_mode")
 setaccount (Deprecated, will be removed in V0.18. To use this command, start bitcoind with -deprecatedrpc=accounts)
 sethdseed ( "newkeypool" "seed" )
 settxfee amount
 signmessage "address" "message"
 signrawtransactionwithwallet "hexstring" ( [{"txid":"id","vout":n,"scriptPubKey":"hex","redeemScript":"hex"},...] sighashtype )
 unloadwallet ( "wallet_name" )
 walletcreatefundedpsbt [{"txid":"id","vout":n},...] [{"address":amount},{"data":"hex"},...] ( locktime ) ( replaceable ) ( options bip32derivs )
 walletlock
 walletpassphrase "passphrase" timeout
 walletpassphrasechange "oldpassphrase" "newpassphrase"
 walletprocesspsbt "psbt" ( sign "sighashtype" bip32derivs )

 == Zmq ==
 getzmqnotifications
\end{lstlisting}

\bigskip
\noindent
You can also type \colorbox{Grey!10}{bitcoin-cli help [command]} to be even more extensive about that command. For example:
\bigskip
\begin{lstlisting}
 $ bitcoin-cli help getmininginfo
 
 getmininginfo

 Returns a json object containing mining-related information.
 Result:
 {
   "blocks": nnn,             (numeric) The current block
   "currentblockweight": nnn, (numeric) The last block weight
   "currentblocktx": nnn,     (numeric) The last block transaction
   "difficulty": xxx.xxxxx    (numeric) The current difficulty
   "networkhashps": nnn,      (numeric) The network hashes per second
   "pooledtx": n              (numeric) The size of the mempool
   "chain": "xxxx",           (string) current network name as defined in BIP70 (main, test, regtest)
   "warnings": "..."          (string) any network and blockchain warnings
 }

 Examples:
 > bitcoin-cli getmininginfo 
 > curl --user myusername --data-binary '{"jsonrpc": "1.0", "id":"curltest", "method": "getmininginfo", "params": [] }' -H 'content-type: text/plain;' http://127.0.0.1:8332/
\end{lstlisting}
\bigskip
\noindent
Here is a list of the most general commands to get additional information about bitcoin data:
\bigskip
\begin{lstlisting}
 $ bitcoin-cli getblockchaininfo
 $ bitcoin-cli getmininginfo
 $ bitcoin-cli getnetworkinfo
 $ bitcoin-cli getnettotals
 $ bitcoin-cli getwalletinfo
\end{lstlisting}
\bigskip
\noindent
For example \colorbox{Grey!10}{bitcoin-cli getwalletinfo} gives the user precise information about the bitcoin wallet, like the confirmed and unconfirmed balance (nota a pie' pagina per spiegare cosa sia unconfirmed balance), and the total number of transactions in the wallet.
\bigskip
\begin{lstlisting}
 $ bitcoin-cli getwalletinfo
 {
  "walletname": "",
  "walletversion": 169900,
  "balance": 0.07825304,
  "unconfirmed_balance": 0.00000000,
  "immature_balance": 0.00000000,
  "txcount": 1,
  "keypoololdest": 1544714806,
  "keypoolsize": 999,
  "keypoolsize_hd_internal": 1000,
  "paytxfee": 0.00000000,
  "hdseedid": "972e6ac8d0104fec0d0e6c052d3876ada965c745",
  "hdmasterkeyid": "972e6ac8d0104fec0d0e6c052d3876ada965c745",
  "private_keys_enabled": true
}
\end{lstlisting}

\bigskip
\noindent
In the next sections we will deal with notarization, in particular we will get into technical details of \textit{OpenTimestamps} protocol.

\bigskip
\section{OpenTimestamps client}
\textit{OpenTimestamps} client is a command-line tool to perform stamping of documents and to verify \textit{OpenTimestamps} proofs, using the Bitcoin blockchain as a timestamp notary. \\
After this step-by-step tutorial we will be able to fully manage the Python release of the \textit{OpenTimestamps} client.

\bigskip
\noindent
Before installing the \textit{OpenTimestamps} client, we must remind that while you can \textit{create} timestamps without a local Bitcoin Core node, to \textit{verify} proofs you need one (a pruned node is fine too, metti la nota per spiegare perche').

\bigskip
\noindent
Let us get into a step-by-step guide to fully manage \textit{OpenTimestamps} client in all its features:
\begin{itemize}
\item Install client (Python3 required):\bigskip
\begin{lstlisting}
 $ pip3 install opentimestamps-client
\end{lstlisting}
\item Install the necessary dependencies:\bigskip
\begin{lstlisting}
 $ sudo apt-get install python3 python3-dev python3-pip python3-setuptools python3-wheel
\end{lstlisting}
\item Pick a file or create a new one to timestamp:\bigskip
\begin{lstlisting}
 $ cat > filename.txt
 bla bla bla (write what you want)
 CTRL+D (to close file and return to command prompt)
\end{lstlisting}
\item Timestamp your example file:\bigskip
\begin{lstlisting}[breakatwhitespace=true]
 $ ots stamp filename.txt 
 Submitting to remote calendar https://a.pool.opentimestamps.org
 Submitting to remote calendar https://b.pool.opentimestamps.org
 Submitting to remote calendar https://a.pool.eternitywall.com
 Submitting to remote calendar  https://ots.btc.catallaxy.com
\end{lstlisting}
Nice! Your timestamp request is submitted to the main public calendar servers.

\bigskip
\noindent
Now in your current directory you must have a file named \colorbox{Grey!10}{filename.txt.ots} that is the proof of your timestamp\footnote{More specifically, an \textit{OpenTimestamps} proof is the path up to merkleroot of the block which contains the relative transaction.}.
\item Verify the proof (local Bitcoin Core node needed):\bigskip
\begin{lstlisting}
 $ ots verify filename.txt.ots 
 Assuming target filename is 'filename.txt'
 Calendar https://bob.btc.calendar.opentimestamps.org: Pending confirmation in Bitcoin blockchain
 Calendar https://alice.btc.calendar.opentimestamps.org: Pending confirmation in Bitcoin blockchain
 Calendar https://btc.calendar.catallaxy.com: Pending confirmation in Bitcoin blockchain
 Calendar https://finney.calendar.eternitywall.com: Pending confirmation in Bitcoin blockchain
\end{lstlisting}
Notice that you can't verify immediately the above-mentioned proof: it takes a few hours for the timestamp to get confirmed by the Bitcoin blockchain; \textit{OpenTimestamps} is not doing one transaction per timestamp.

\bigskip
\noindent
Now the proof is \textit{incomplete} because it needs the assistance of a remote calendar to verify; the calendar provides the path to the Bitcoin block header. You can check for the current status of your proof file with the \colorbox{Grey!10}{info} command.
\item Get detailed proof information:\bigskip
\begin{lstlisting}[breakatwhitespace=true]
 $ ots info filename.txt.ots 
 File sha256 hash: 13a1f687ddb7c1a0b12adeb708a2b464c9 cfc24d5c9def4fa775cca81162feed
 Timestamp:
 append 5669aa818cc1c5bf8129d469f884fe79
 sha256
  -> append 0f2a11ae083c66674d9d0d3da049079e
     sha256
     prepend f6836f41e86344eb7e4da03fe57c3e998d13594b2a27b4 ccb86cef8ac19cf69e
     sha256
     prepend 5c502267
     append 2c767f767b02b45c
     verify PendingAttestation ('https://bob.btc.calendar.opentimestamps.org')
  -> append 675406ae56e9e40809ac587ee009067c
     sha256
     append 7690b939b5a663ea311992aadf2f182424cea544bbfb2a 837ae366ba5cc1ecf4
     sha256
     prepend 5c502266
     append 1269e2007cc47092
     verify PendingAttestation ('https://alice.btc.calendar.opentimestamps.org')
  -> append 9b10d7ec7f0af842407d2d7cbebac9ad
     sha256
     prepend 5c502267
     append da1d41ee8803dff5
     verify PendingAttestation ('https://btc.calendar.catallaxy.com')
  -> append f923446e73e3a503121a56006723a6c1
     sha256
     append c35e379ef7097a65fdbfb2a594a93c75
     sha256
     prepend 5c502266
     append c47a3b08bfc2315e
     verify PendingAttestation ('https://finney.calendar.eternitywall.com')
\end{lstlisting}
Incomplete timestamps can be upgraded using the \colorbox{Grey!10}{upgrade} command which adds the path to the Bitcoin blockchain to the timestamp itself. Upgrading a proof isn't always available: there must be at least one completed attestation.
\item Upgrade the proof: \bigskip
\begin{lstlisting}[breakatwhitespace=true]
 $ ots upgrade filename.txt.ots 
 Got 1 attestation(s) from https://bob.btc.calendar.opentimestamps.org
 Got 1 attestation(s) from https://alice.btc.calendar.opentimestamps.org
 Got 1 attestation(s) from https://btc.calendar.catallaxy.com
 Got 1 attestation(s) from https://finney.calendar.eternitywall.com
 Success! Timestamp complete
\end{lstlisting}
In this case the timestamp is fully confirmed by Bitcoin Blockchain, so upgrading the proof succeeded.

\bigskip
\noindent
Now that we know for sure that timestamping succeeded, you only left to verify the proof another time to check which block attested your timestamp (add the flag \colorbox{Grey!10}{-v} to be more verbose).\bigskip
\begin{lstlisting}[breakatwhitespace=true]
 $ ots -v verify filename.txt.ots
 Assuming target filename is 'filename.txt'
 Hashing file, algorithm sha256
 Got digest 13a1f687ddb7c1a0b12adeb708a2b464c9cfc24d5c9def 4fa775cca81162feed
 Attestation block hash: 00000000000000000013e603482 1d3d85e8a8ff0217482e4b2ab602ec7ab6ce7
 Success! Bitcoin block 560604 attests existence as of 2019-01-29 CET
\end{lstlisting}
\end{itemize}

